<html>
<head>
  <meta charset="UTF-8" />
  <meta
          name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
  />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>MiBand Heartrate</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<div id="chart"></div>
<div id="container">
  <div class="init">
    <div class="form-group">
      <label for="auth-key"
      >MiBand HeartLate Monitor
        <button
                onclick="openAuth()"
        >GetToken</button
        >
      </label>
    </div>
    <div class="form-group">
      <select
              id="auth-key"
              style="width:100%;height: 32px"
      >
      </select>
    </div>
    <label class="form-group">
      <input type="checkbox" id="miband5" />use Miband 6
    </label>
    <div class="form-group">
      <button id="connect-button">Connect</button>
    </div>
  </div>
  <div class="hr d-none">
    <h1 id="heartrate">
      <span id="hr">-</span><span class="unit">BPM</span>
    </h1>
  </div>
</div>

<script src="aes.js"></script>
<script src="ecdh.js"></script>
<script src="bundle.js"></script>
<script>
  const chart = new Chart("#chart");
  const hr = document.querySelector("#hr");
  const connectButton = document.querySelector("#connect-button");
  const keyInput = document.querySelector("#auth-key");
  const miband5 = document.querySelector("#miband5");
  const initBox = document.querySelector(".init");
  const hrBox = document.querySelector(".hr");
  let authKey = localStorage.getItem("auth-key");
  if (authKey) {
    keyInput.value = authKey;
  }

  miband5.checked = localStorage.getItem("miband5") == "true";

  miband5.addEventListener("change", e => {
    localStorage.setItem("miband5", miband5.checked);
  })

  connectButton.addEventListener("click", async () => {
    authKey = keyInput.options[keyInput.selectedIndex].value;
    window.addEventListener("connected", (e) => {
      initBox.classList.add("d-none");
      hrBox.classList.remove("d-none");
      localStorage.setItem("auth-key", authKey);
    });
    window.addEventListener("heartrate", (e) => {
      console.log("Got heartrate", e.detail);
      hr.innerText = e.detail;
      chart.update(e.detail);
    });
    try {
      window.miband = !miband5.checked ? new MiBand5(authKey) : new MiBand6(authKey);
      await window.miband.init();
    } catch (e) {
      alert(e.message);
    }
  });
</script>
<script>
  const { ipcRenderer } = require('electron');

  function openAuth() {
    ipcRenderer.send('open-miband-auth', {});
  }

  ipcRenderer.on('key', (evt,msg) => {
    console.log('receive message: key')
    console.log(msg)
    const select = document.getElementById("auth-key")
    const keys = msg.filter(i => !!i)
    keys.forEach(m => {
      let option = document.createElement("option");
      option.text = m
      option.value = m
      select.appendChild(option);
    })
    localStorage.setItem("MiBandKeys",keys)
  })

  ipcRenderer.on('log', (evt,msg) => {
    console.log(msg)
  })

  window.onload = function () {
    const keys = localStorage.getItem("MiBandKeys")
    if(!keys) return

    const select = document.getElementById("auth-key")
    const split = keys.split(",")
    split.forEach(m => {
      let option = document.createElement("option");
      option.text = m
      option.value = m
      select.appendChild(option);
    })
  }
</script>
</body>
</html>
